services:
  gri:
    hostname: gri
    image: ghcr.io/yudejp/gri:master
    container_name: gri
    restart: always
    environment:
      - TZ=Asia/Tokyo
    ports:
      - "9292:9292"
    user: root
    volumes:
      - ./gritab:/usr/local/gri/gritab:ro
      - ./tra:/usr/local/gri/tra
      - ./gra:/usr/local/gri/gra
    extra_hosts:
      - "ibr1gw1.ibr1.yude.jp:100.93.170.11"
      - "router1.pepepper.net:100.93.170.11"
      - "router2.pepepper.net:100.93.170.11"
      - "gateway.local.kusaremkn.com:100.109.169.61"
      - "mf720c.pepepper.net:100.93.170.11"
      - "SHINTRANET-IX2215.shinanomai.xyz:100.86.190.92"
      - "hnd2sh1.tun.y2e.org:100.76.111.80"
      - "wabi1750ps.internal.sgchsgch.net:100.113.233.68"
      - "raritan.internal.sgchsgch.net:100.113.233.68"
      - "DCPJ925N.ttj1.yude.jp:100.104.62.51"
      - "printer.local.kusaremkn.com:100.109.169.61"
      - "sdj1gw1.sdj1.yude.jp:100.71.26.108"
    command:
      - sh
      - -lc
      - |
        set -eu
        /usr/local/bundle/bin/grapher -h 0.0.0.0 -p 9292 &
        web_pid=$$!
        trap 'kill "$$web_pid" 2>/dev/null || true; exit 0' INT TERM
        while true; do
          if ! kill -0 "$$web_pid" 2>/dev/null; then
            echo "grapher exited" >&2
            exit 1
          fi
          /usr/local/bundle/bin/gri
          sleep "$${GRI_INTERVAL:-300}"
        done
  cloudflared:
    image: cloudflare/cloudflared:latest
    user: root
    restart: always
    command: tunnel --no-autoupdate run --token $CLOUDFLARED_TOKEN
